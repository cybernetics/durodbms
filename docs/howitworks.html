<html>
<head>
<title>Dreisam &ndash; how it works</title>
<link rel="stylesheet" href="style.css">
<body>

<h1>Dreisam &ndash; how it works</h1>

<h2>Introduction</h2>

<p>Dreisam is an MVC web application framework inspired by frameworks like Spring MVC and Rails.

<p>Dreisam works by serving FastCGI requests. To run Dreisam applications, FastCGI must be enabled in the webserver.

<p>The FastCGI request are processed by the front controller dreisam.fcgi which is placed in the fcgi-bin directory.

<p>At startup, dreisam.fcgi reads the configuration file fcgi-bin/dreisam/config.td and
connects to a database environment.

<p>An example configuration file looks like this:

<pre>
dbenv := 'dreisam/data/dbenv';
current_db := 'SDB';
</pre>

<p>This means that the database environment directory is fcgi-bin/dreisam/data/dbenv and that the default database is SDB.

<p>The database environment directory and all its files must be readable and writable by the webserver.

<p>The simplest way to achieve this is to make the user under which the webserver runs the owner of the directory and its files.
You then probably have to issue a 'sudo' to access the database from your user.

<p>The script td/setup.td creates the necessary table and operators for processing requests. td/template.td contains the operators for template processing.

<h2>A simple hello application</h2>

<p>Let's create a small application which receives a name with the request and sends a hello message back.

<p>First, we need an action. For an action there must be an entry in the http_actions table and an update operator.

<p>So let's create both:

<pre>
insert http_actions tup { path '/hello', opname 'hello', method 'GET' };

operator hello (model tup { name string }, view string) updates { model, view };
    ; /* Do nothing */
end operator;
</pre>

<p>This maps the path /hello to the action operator <em>hello</em>.

<p>The action operator receives the request data in the <var>model</var> argument and a view name in
the <var>view</var> argument.

<p>The view name passed to the operator is the path without the leading slash, so it is simply 'hello'.

<p>In this simple example, both the model and the view don't have to be modified, so the operator
body doesn't do anything. The semicolon is there because at least one statement is required in the operator body.

<p>When the action has been executed, the front controller maps the view name to a template and processes the template using the model.
For a view named 'hello', the template is hello.thtml. <a href="templates.html">Read more about the template language.</a>

<p>As templates are located in fcgi-bin/dreisam/views, let's create the following hello.thtml right there:

<pre>
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Hello&lt;/title&gt;
&lt;body&gt;

&lt;p&gt;Hello {$ m.name $}!

&lt;/html&gt;
</pre>

<p>If we now issue a GET request by entering the following line into the browser's location field:

<pre>
http://localhost/fcgi-bin/dreisam.fcgi/hello?name=John
</pre>

<p>we get:

<pre>
Hello John!
</pre>

<h2>Redirecting</h2>

<p>By setting the view to the empty string, a controller can prevent the template rendering.

<p>For example, a controller which redirects to http://someothersite.com/
using HTTP response code 303 can be created as follows:

<pre>
insert http_actions tup { path '/redirect', opname 'redirect', method 'GET' };

operator redirect (model tup { }, view string, resp http.http_response) updates { model, view };
    http.set_status(resp, 303);
    http.set_response_header(resp, 'Location', 'http://someothersite.com/');
    view := '';
end operator;
</pre>

<p>The operators http.set_status and http.set_response_header require an argument of
type http.http_response. This can be made available by adding an argument of this type
to the action operator.

<h2>Sending JSON data</h2>

<p>An action operator can send a JSON response using the operator send_json_response:

<pre>
insert http_actions tup { path '/jsonexample', opname 'jsonexample', method 'GET' };

operator jsonexample (model tup { name string, no int, price float }, view string,
        resp http.http_response)
        updates { model, view };
    model := tup { name 'Cap', no 22, price 10.97 };

    view := '';
    http.send_json_response(resp, model);
end operator;
</pre>

<p>The request

<pre>
http://localhost/fcgi-bin/dreisam.fcgi/jsonexample
</pre>

<p>will produce the following output:

<pre>
{
"no": 22,
"name": "Cap",
"price": 10.97
}
</pre>

</html>
